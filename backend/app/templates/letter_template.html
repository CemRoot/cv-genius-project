<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ personal_details.full_name }} - Cover Letter</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Times New Roman', 'Arial', serif;
            line-height: 1.15;
            color: #000000;
            font-size: 11pt;
            background-color: #f5f5f5;
        }
        
        .page {
            width: 210mm;           /* A4 genişliği */
            min-height: 297mm;      /* A4 yüksekliği */
            padding: 20mm;          /* İç boşluk: 20 mm */
            margin: 0 auto;         /* Ortala */
            background: #fff;
            box-sizing: border-box; /* Kenarlık + padding dâhil */
            overflow: hidden;
            line-height: 1.15;      /* Sıkışmayı engelle */
            font-family: 'Times New Roman', 'Arial', serif;
            font-size: 11pt;
            color: #000000;
        }
        
        .container {
            max-width: none;
            margin: 0;
            padding: 0;
            background: transparent;
        }
        
        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid #000000;
            padding-bottom: 15px;
        }
        
        .sender-info {
            text-align: left;
            margin-bottom: 20px;
        }
        
        .name {
            font-size: 14pt;
            font-weight: 700;
            color: #000000;
            margin-bottom: 12pt;    /* 12pt spacing after header */
            letter-spacing: 0px;
        }
        
        .contact-info {
            font-size: 10pt;
            color: #000000;
            line-height: 1.3;
        }
        
        .contact-info div {
            margin-bottom: 3px;
        }
        
        .date {
            text-align: right;
            font-size: 10pt;
            color: #000000;
            margin-bottom: 25mm;
            font-weight: 400;
        }
        
        .recipient {
            margin-bottom: 20px;
            font-size: 10pt;
            color: #000000;
            line-height: 1.3;
        }
        
        .recipient div {
            margin-bottom: 2px;
        }
        
        .salutation {
            font-size: 11pt;
            margin-bottom: 20px;
            color: #000000;
            font-weight: 400;
        }
        
        .letter-body {
            font-size: 11pt;
            line-height: 1.5;
            color: #000000;
            text-align: justify;
            margin-bottom: 25px;
        }
        
        .letter-body p {
            margin: 0 0 10pt 0;     /* 10pt spacing between paragraphs */
            text-indent: 0;
            line-height: 1.6;
        }
        
        .letter-body p:first-child {
            margin-top: 0;
        }
        
        .letter-body p:last-child {
            margin-bottom: 0;
        }
        
        .closing {
            margin-bottom: 30px;
            margin-top: 20px;
        }
        
        .closing-phrase {
            font-size: 11pt;
            color: #000000;
            margin-bottom: 20px;
            font-weight: 400;
        }
        
        .signature {
            font-size: 11pt;
            font-weight: 700;
            color: #000000;
            margin-top: 5px;
        }
        
        @media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
                margin: 0;
                padding: 0;
            }
            
            @page {
                margin: 0;                 /* PDF kenar boşluğu sıfır */
                size: A4 portrait;
            }
            
            .page { 
                page-break-after: always;           /* Her .page yeni sayfa */
                margin: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                box-sizing: border-box;
            }
            
            .header {
                page-break-after: avoid;
            }
            
            .name, .salutation {
                page-break-after: avoid;        /* Başlıkların altında kopma olmasın */
            }
            
            .letter-body {
                orphans: 3;
                widows: 3;                       /* Kötü kopmaların önüne geç */
            }
            
            .letter-body p {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="page" id="cover-letter">
        <div class="container">
            <!-- Header with sender info -->
            <div class="header">
                <div class="sender-info">
                    <div class="name">{{ personal_details.full_name }}</div>
                    <div class="contact-info">
                        <div>{{ personal_details.email }}</div>
                        <div>{{ personal_details.phone }}</div>
                        {% if personal_details.location %}<div>{{ personal_details.location }}</div>{% endif %}
                        {% if personal_details.linkedin_url %}<div>{{ personal_details.linkedin_url }}</div>{% endif %}
                    </div>
                </div>
                
                <div class="date">
                    {{ generation_date or "Date" }}
                </div>
            </div>

            <!-- Recipient -->
            <div class="recipient">
                <div>{{ company_name or "[Company Name]" }}</div>
                {% if include_company_address and company_address %}
                {% for line in company_address.split('\n') %}
                    {% if line.strip() %}<div>{{ line.strip() }}</div>{% endif %}
                {% endfor %}
                {% elif include_company_address %}
                <div>[Company Address]</div>
                {% endif %}
            </div>

            <!-- Salutation -->
            <div class="salutation">
                {% if company_name and company_name != "[Company Name]" %}
                Dear {{ company_name }} Team,
                {% else %}
                Dear Hiring Manager,
                {% endif %}
            </div>

            <!-- Letter Body -->
            <div class="letter-body">
                {% set cleaned_body = cover_letter_body 
                    | replace('Sincerely,', '') 
                    | replace('Dear Hiring Manager,', '') 
                    | replace('Dear Hiring Team,', '') 
                    | replace('Dear ' + (company_name if company_name and company_name != '[Company Name]' else '') + ' Team,', '')
                    | replace('Dear ' + (company_name if company_name and company_name != '[Company Name]' else '') + ' Hiring Team,', '')
                    | replace('Dear Sir/Madam,', '')
                    | replace('To Whom It May Concern,', '')
                    | replace('Best regards,', '') 
                    | replace('Kind regards,', '') 
                    | replace('Yours faithfully,', '')
                    | replace('Yours sincerely,', '')
                    | replace('I am writing to apply', 'My experience makes me well-suited')
                    | replace('I am writing to express my interest', 'My background aligns perfectly with')
                    | replace('I would like to apply', 'I am excited to apply my skills')
                    | replace('[Company Name]', company_name if company_name and company_name != '[Company Name]' else '')
                    | replace('[Platform where you saw the advert]', '')
                    | replace('[Job Title]', '')
                    | replace('[Position]', '')
                    | replace('—', '-')
                    | replace('  ', ' ')
                    | replace('   ', ' ')
                %}
                
                <!-- Check if content already has HTML paragraph tags -->
                {% if '<p>' in cleaned_body and '</p>' in cleaned_body %}
                    <!-- Content already formatted with HTML tags -->
                    {{ cleaned_body | safe }}
                {% else %}
                    <!-- Format as plain text paragraphs -->
                    {% if '\n\n' in cleaned_body %}
                        {% set paragraphs = cleaned_body.split('\n\n') %}
                    {% else %}
                        {% set paragraphs = cleaned_body.split('\n') %}
                    {% endif %}
                    
                    {% for paragraph in paragraphs %}
                        {% set clean_paragraph = paragraph.strip() 
                            | replace('\n', ' ') 
                            | replace('  ', ' ')
                            | replace('   ', ' ')
                            | replace('....', '.')
                            | replace('...', '.')
                            | replace('..', '.')
                        %}
                        {% set paragraph_lower = clean_paragraph.lower() %}
                        
                        {% if clean_paragraph 
                            and clean_paragraph|length > 10
                            and not paragraph_lower.strip().startswith('sincerely')
                            and not paragraph_lower.strip().startswith('best regards')
                            and not paragraph_lower.strip().startswith('kind regards')
                            and not paragraph_lower.strip().startswith('dear ')
                            and not paragraph_lower.strip().startswith('yours faithfully')
                            and not paragraph_lower.strip().startswith('yours sincerely')
                            and not paragraph_lower.strip().startswith('to whom it may concern')
                            and not paragraph_lower.strip().endswith('sincerely,')
                            and not paragraph_lower.strip().endswith('best regards,')
                            and not paragraph_lower.strip().endswith('kind regards,')
                            and not paragraph_lower.strip().endswith('sincerely.')
                            and not clean_paragraph.strip() == ''
                        %}
                            <p>{{ clean_paragraph }}</p>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Fallback: If no paragraphs are shown, show cleaned body directly -->
                    {% set paragraph_count = 0 %}
                    {% for paragraph in paragraphs %}
                        {% set clean_paragraph = paragraph.strip() 
                            | replace('\n', ' ') 
                            | replace('  ', ' ')
                            | replace('   ', ' ')
                        %}
                        {% set paragraph_lower = clean_paragraph.lower() %}
                        {% if clean_paragraph 
                            and clean_paragraph|length > 10
                            and not paragraph_lower.strip().startswith('sincerely')
                            and not paragraph_lower.strip().startswith('best regards')
                            and not paragraph_lower.strip().startswith('kind regards')
                            and not paragraph_lower.strip().startswith('dear ')
                            and not paragraph_lower.strip().startswith('yours faithfully')
                            and not paragraph_lower.strip().startswith('yours sincerely')
                            and not paragraph_lower.strip().startswith('to whom it may concern')
                            and not paragraph_lower.strip().endswith('sincerely,')
                            and not paragraph_lower.strip().endswith('best regards,')
                            and not paragraph_lower.strip().endswith('kind regards,')
                            and not paragraph_lower.strip().endswith('sincerely.')
                            and not clean_paragraph.strip() == ''
                        %}
                            {% set paragraph_count = paragraph_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if paragraph_count == 0 and cleaned_body %}
                        <p>{{ cleaned_body | replace('\n', ' ') | replace('  ', ' ') }}</p>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Closing -->
            <div class="closing">
                <div class="closing-phrase">
                    Yours sincerely,
                </div>
                <div class="signature">
                    {{ personal_details.full_name }}
                </div>
            </div>
        </div>
    </div>
</body>
</html>